<VirtualHost *:<%= @params[:server_port] || node['apache']['listen_ports'].first %>>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join(" ") %>
  <% end -%>

  # Pass /static/ through apache itself into the relevant dirs.
  ProxyPassMatch ^/static/[0-9a-fA-F]{8}\/(.*)$ !
  AliasMatch ^/static/[0-9a-fA-F]{8}\/plugin\/(.*)$ /var/lib/jenkins/plugins/$1
  <Directory "<%= @params[:jenkinshome] %>/plugins">
      Options FollowSymLinks
      AllowOverride None
      Require all granted
  </Directory>
  AliasMatch ^/static/[0-9a-fA-F]{8}\/(.*)$ /var/cache/jenkins/war/$1
  <Directory "<%= @params[:jenkinsroot] %>/war">
      Options FollowSymLinks
      AllowOverride None
      Require all granted
  </Directory>

  ProxyPass         /  http://localhost:8080/ nocanon
  ProxyPassReverse  /  http://localhost:8080/
  #ProxyRequests     Off
  AllowEncodedSlashes NoDecode

  # Local reverse proxy authorization override
  # Most unix distribution deny proxy by default (ie /etc/apache2/mods-enabled/proxy.conf in Ubuntu)
  <Proxy http://localhost:8080/*>
    Require all granted
  </Proxy>

  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined
</VirtualHost>
