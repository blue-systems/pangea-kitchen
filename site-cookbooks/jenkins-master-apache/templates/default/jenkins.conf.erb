<VirtualHost *:<%= @params[:server_port] || node['apache']['listen_ports'].first %>>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join(" ") %>
  <% end -%>

  # Resume build can be called from anonymous scope as it has 0 permission
  # checks (probably because it implements an upstream cause) which can result
  # in anonymous users breaking builds by resuming at a non-resumable point
  # in time.
  # https://issues.jenkins-ci.org/browse/JENKINS-36333
  <LocationMatch ^/(.+)/resume>
    Order Allow,Deny
    Deny from all
  </LocationMatch>
  ProxyPassMatch ^/(.+)/resume$ !

  ProxyPass         /  http://localhost:8080/ nocanon
  ProxyPassReverse  /  http://localhost:8080/
  #ProxyRequests     Off
  AllowEncodedSlashes NoDecode

  # Local reverse proxy authorization override
  # Most unix distribution deny proxy by default (ie /etc/apache2/mods-enabled/proxy.conf in Ubuntu)
  <Proxy http://localhost:8080/*>
    Require all granted
  </Proxy>

  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined
</VirtualHost>
